按键驱动函数说明书
编写日期：2025/07/17
作者：SleepyCats 团队

一、概述
本文件为基于 GD32F30x 系列单片机的状态机式按键驱动模块，通过轮询方式扫描按键状态，支持短按与长按识别，并具备消抖处理机制。主要文件为 key_drv.c，用于实现多按键检测与处理。

二、功能说明
该驱动可检测最多三个按键的按下动作，并将按键状态分为以下几种：

KEY_RELEASE：按键释放状态

KEY_CONFIRM：按键初次按下，等待消抖确认

KEY_SHORTPRESS：短按状态（按下并释放在 1 秒以内）

KEY_LONGPRESS：长按状态（持续按下超过 1 秒）

按键按下后的返回值如下：

按键编号	短按返回值	长按返回值
key1	0x01	0x81
key2	0x02	0x82
key3	0x03	0x83

若无按键按下，则返回值为 0。

三、按键连接说明
按键信号输入采用**浮空输入模式（GPIO_MODE_IN_FLOATING）**配置，当前默认引脚为：

按键编号	GPIO端口	引脚
key1	GPIOA	PIN0
key2	GPIOG	PIN13
key3	GPIOG	PIN14

四、主要宏定义
c
复制
编辑
#define CONFIRM_TIME   10    // 消抖时间窗（单位：ms）
#define LONGPRESS_TIME 1000  // 长按识别时间窗（单位：ms）
五、结构体说明
Key_GPIO_t
用于描述每个按键的 GPIO 配置：

c
复制
编辑
typedef struct {
    rcu_periph_enum rcu;  // 外设时钟
    uint32_t gpio;        // GPIO端口
    uint32_t pin;         // GPIO引脚
} Key_GPIO_t;
Key_Info_t
用于跟踪按键的状态及时间：

c
复制
编辑
typedef struct {
    KEY_STATE keyState;   // 当前按键状态
    uint64_t prvSysTime;  // 状态变化的时间戳
} Key_Info_t;
六、函数接口说明
1. void KeyDrvInit(void)
按键初始化函数，完成 GPIO 时钟配置和输入模式设置。

2. uint8_t KeyScan(uint8_t keyIndex)
内部使用的状态机扫描函数，用于处理第 keyIndex 个按键的状态转移。

参数：

keyIndex: 按键索引 (0, 1, 2)

返回值：

对应按键的短按或长按码值（0x010x03 或 0x810x83）

若无事件则返回 0

3. uint8_t GetKeyVal(void)
按键事件获取接口，轮询每个按键，返回最先识别的有效按键码值。

返回值：

0x01~0x03：短按码值

0x81~0x83：长按码值

0：无按键动作

七、使用说明
在主程序中调用 KeyDrvInit() 完成初始化。

在主循环中定时调用 GetKeyVal()，即可获取当前按键操作值。

使用返回值判断按键动作，并执行对应逻辑处理。

八、注意事项
本驱动基于轮询机制，应在 5~10ms 定时调用以保证响应速度。

当前使用 GetSysRunTime() 获取系统运行时间，需确保系统时基正常。

长按识别基于持续按压超过 LONGPRESS_TIME，释放后才返回码值。
