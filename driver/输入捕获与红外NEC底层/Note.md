### 笔记：输入捕获与红外NEC通讯协议

#### 1. 输入捕获概述
输入捕获（Input Capture）是一种基于定时器的功能，用于捕获外部信号的时序信息。它的主要作用是测量输入信号的脉冲宽度或周期，通常用于解码红外遥控信号等场景。在提供的代码中，输入捕获通过定时器（TIMER7）实现，捕获GPIO引脚上的信号变化（如下降沿）并记录计数值。

- **工作原理**：
  - 定时器配置一个预分频器和自动重装载值，生成一个固定的计时单位（代码中为1μs）。
  - 当检测到指定边沿（例如下降沿）时，捕获当前计数值。
  - 通过计算两次捕获值之间的差值，得到信号的脉冲宽度。

- **代码实现**：
  - `timer_input_capture_config` 配置了下降沿捕获和直接输入通道。
  - 中断服务函数 `TIMER7_Channel_IRQHandler` 在捕获到信号时读取计数值 `icValue`，并调用 `ParseIrFrame` 进行解析。

#### 2. 红外NEC通讯协议
NEC协议是一种常见的红外遥控通讯协议，采用脉宽调制（PWM）编码方式，通过脉冲的宽度来表示二进制数据（0或1）。以下是协议的关键特点：

- **引导码（Header）**：
  - 引导码由一个9ms的高电平和一个4.5ms的低电平组成，用于标识数据帧的开始。
  - 代码中定义了 `TICK_HEAD_MIN (10000us)` 和 `TICK_HEAD_MAX (20000us)` 来检测引导码。

- **数据位**：
  - 每个数据位由一个0.56ms的高电平开始，后面跟随着不同的低电平宽度：
    - 逻辑“0”：低电平持续0.56ms（总周期约1.12ms），范围 `TICK_0_MIN (500us)` 到 `TICK_0_MAX (1800us)`。
    - 逻辑“1”：低电平持续1.69ms（总周期约2.25ms），范围 `TICK_1_MIN (1800us)` 到 `TICK_1_MAX (3000us)`。
  - 数据帧总共32位，包括8位地址、8位地址反码、8位命令和8位命令反码。

- **校验**：
  - NEC协议通过比较命令码（`g_irCode[2]`）与其反码（`g_irCode[3]`）是否互补来验证数据完整性。
  - 如果 `(g_irCode[2] & g_irCode[3]) == 0`，则数据被认为有效，设置 `g_irCodeFlag` 为真。

- **代码解析**：
  - 函数 `ParseIrFrame` 根据捕获的 `tickNum` 判断是引导码还是数据位，并更新 `g_irCode` 数组。
  - 当解析完32位数据后，检查校验并通过 `GetIrCode` 返回有效的按键码。

#### 3. 代码结构与初始化
- **GPIO初始化（GpioInit）**：
  - 使能GPIOC时钟，配置PC6为浮空输入模式，用于接收红外信号。
- **定时器初始化（TimerInit）**：
  - 配置TIMER7，预分频器为120-1，使输入时钟为1MHz（1μs周期）。
  - 设置自动重装载值为65535，允许捕获较长的脉冲。
  - 启用中断并配置为下降沿捕获。
- **红外驱动初始化（IrDrvInit）**：
  - 结合GPIO和定时器初始化，完成硬件准备。

#### 4. 注意事项
- 定时器计数值可能因硬件延迟或噪声而有微小偏差，需确保信号质量。
- 引导码和数据位的时序范围需根据实际硬件调整（如 `TICK_HEAD_MIN/MAX` 等宏定义）。
- 中断处理需及时清零标志位，避免误触发。
